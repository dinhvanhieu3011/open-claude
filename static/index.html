<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src * data:;">
  <title>Claude</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      background: transparent;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      color: #000;
      height: 100vh;
      display: flex;
      flex-direction: column;
      -webkit-font-smoothing: antialiased;
    }

    @media (prefers-color-scheme: dark) {
      body { color: #fff; }
    }

    /* Login */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      padding: 40px;
    }

    .login-card {
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(80px) saturate(200%);
      -webkit-backdrop-filter: blur(80px) saturate(200%);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      padding: 44px 52px;
      text-align: center;
      max-width: 320px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    }

    .logo {
      width: 180px;
      height: 96px;
      margin: 0 auto 24px;
    }
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .login-container h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.4px;
      margin-bottom: 6px;
    }

    .login-container .subtitle {
      color: rgba(0, 0, 0, 0.5);
      font-size: 14px;
      margin-bottom: 28px;
    }

    .login-btn {
      background: linear-gradient(145deg, #CC785C 0%, #D4846A 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(204, 120, 92, 0.3);
    }

    .login-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(204, 120, 92, 0.4);
    }
    .login-btn:active { transform: scale(0.98); }

    .error { color: #FF453A; font-size: 11px; margin-top: 12px; }

    /* Home page */
    .home-container {
      display: none;
      flex-direction: column;
      height: 100vh;
      position: relative;
    }
    .home-container.active { display: flex; }

    .home-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
    }

    /* Draggable header area for home page */
    .home-drag-region {
      position: absolute;
      top: 0;
      left: 30px; /* Leave space for sidebar tab */
      right: 0;
      height: 50px;
      -webkit-app-region: drag;
    }

    .home-logo {
      display: none;
    }

    .home-input-area {
      width: 100%;
      max-width: 600px;
      -webkit-app-region: no-drag;
      text-align: center;
    }

    .home-input-wrapper {
      background: transparent;
      padding: 0;
    }

    .home-input {
      width: 100%;
      background: transparent;
      border: none;
      border-bottom: 1px solid rgba(0, 0, 0, 0.15);
      font-size: 18px;
      font-family: inherit;
      color: #000;
      outline: none;
      resize: none;
      min-height: 28px;
      max-height: 200px;
      line-height: 1.5;
      padding: 8px 0;
      caret-color: #CC785C;
    }

    .home-input::placeholder {
      color: rgba(0, 0, 0, 0.3);
    }

    .home-input:focus {
      border-bottom-color: #CC785C;
    }

    .home-input-footer {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .home-send-btn {
      display: none;
    }

    .model-selector {
      display: flex;
      gap: 6px;
    }

    .model-option {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      background: transparent;
      border: 1px solid rgba(0, 0, 0, 0.1);
      color: rgba(0, 0, 0, 0.5);
      cursor: pointer;
      transition: all 0.15s;
    }

    .model-option:hover {
      background: rgba(0, 0, 0, 0.04);
      color: rgba(0, 0, 0, 0.7);
    }

    .model-option.active {
      background: linear-gradient(145deg, #CC785C 0%, #D4846A 100%);
      border-color: transparent;
      color: white;
    }


    .home-footer {
      position: absolute;
      bottom: 0;
      right: 0;
      padding: 16px;
      display: flex;
      justify-content: flex-end;
      -webkit-app-region: no-drag;
    }

    .home-signout {
      font-size: 12px;
      color: rgba(0, 0, 0, 0.4);
      background: none;
      border: none;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.15s;
    }

    .home-signout:hover {
      background: rgba(0, 0, 0, 0.05);
      color: rgba(0, 0, 0, 0.6);
    }

    /* Home to Chat transition animation */
    .home-container.transitioning {
      pointer-events: none;
    }

    .home-container.transitioning .home-content {
      animation: homeContentFadeOut 0.4s ease-out forwards;
    }

    .home-container.transitioning .home-input-area {
      animation: inputAreaMoveDown 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .home-container.transitioning .home-input-footer {
      animation: footerFadeOut 0.25s ease-out forwards;
    }

    @keyframes homeContentFadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    @keyframes inputAreaMoveDown {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      60% {
        transform: translateY(calc(50vh - 100px));
        opacity: 1;
      }
      100% {
        transform: translateY(calc(50vh - 80px));
        opacity: 0;
      }
    }

    @keyframes footerFadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Chat container entrance animation */
    .chat-container.entering {
      display: flex;
      opacity: 0;
      animation: chatEnter 0.1s ease-out 0.3s forwards;
    }

    @keyframes chatEnter {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* First user message fly-in animation */
    .message.fly-in {
      animation: messageFlyIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes messageFlyIn {
      0% {
        opacity: 0;
        transform: translateY(100px) scale(0.95);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Assistant message fade-in */
    .message.fade-in {
      animation: messageFadeIn 0.3s ease-out forwards;
    }

    @keyframes messageFadeIn {
      0% {
        opacity: 0;
        transform: translateY(10px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Chat container */
    .chat-container { display: none; flex-direction: column; height: 100vh; position: relative; }
    .chat-container.active { display: flex; }

    /* Header */
    .header {
      padding: 0 16px;
      height: 44px;
      background: transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
      -webkit-app-region: drag;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 70px;
    }

    .icon-btn {
      width: 28px;
      height: 28px;
      background: transparent;
      border: none;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      -webkit-app-region: no-drag;
      transition: all 0.15s;
      font-size: 15px;
      color: rgba(0, 0, 0, 0.45);
    }

    .icon-btn:hover {
      background: rgba(0, 0, 0, 0.06);
      color: rgba(0, 0, 0, 0.7);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .model-badge {
      font-size: 11px;
      color: rgba(0, 0, 0, 0.4);
      padding: 0;
      font-weight: 500;
    }

    .sign-out-btn {
      background: transparent;
      border: none;
      color: rgba(0, 0, 0, 0.4);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .sign-out-btn:hover {
      background: rgba(0, 0, 0, 0.06);
      color: rgba(0, 0, 0, 0.7);
    }

    /* Sidebar overlay */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s, visibility 0.25s;
      z-index: 100;
    }

    .sidebar-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 100%;
      background: rgba(246, 246, 246, 0.97);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border-right: 1px solid rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 101;
      display: flex;
      flex-direction: column;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    /* Sidebar trigger tab - invisible hover zone spanning 70% of height */
    .sidebar-tab {
      position: fixed;
      left: 0;
      top: 15%;
      width: 6px;
      height: 70%;
      background: transparent;
      cursor: pointer;
      z-index: 99;
      -webkit-app-region: no-drag;
    }

    .sidebar-tab:hover {
      width: 24px;
    }

    /* The visual indicator that follows the mouse */
    .sidebar-tab-indicator {
      position: absolute;
      left: 0;
      width: 6px;
      height: 60px;
      background: rgba(0, 0, 0, 0.08);
      border-radius: 0 4px 4px 0;
      transform: translateY(-50%);
      transition: width 0.2s, background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      opacity: 0;
    }

    .sidebar-tab:hover .sidebar-tab-indicator {
      width: 24px;
      background: rgba(0, 0, 0, 0.12);
      opacity: 1;
    }

    .sidebar-tab-indicator::after {
      content: '';
      width: 2px;
      height: 20px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 1px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .sidebar-tab:hover .sidebar-tab-indicator::after {
      opacity: 1;
    }

    .sidebar-tab.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-header {
      padding: 12px 16px;
      padding-top: 48px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      color: rgba(0, 0, 0, 0.7);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sidebar-spacer {
      flex: 1;
    }

    .new-chat-btn {
      width: 24px;
      height: 24px;
      background: #CC785C;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      font-weight: 300;
      color: white;
      transition: all 0.15s;
      box-shadow: 0 2px 6px rgba(204, 120, 92, 0.3);
    }

    .new-chat-btn:hover {
      background: #B86A50;
      transform: scale(1.05);
      box-shadow: 0 3px 8px rgba(204, 120, 92, 0.4);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .sidebar-content::-webkit-scrollbar { display: none; }
    .sidebar-content { -ms-overflow-style: none; scrollbar-width: none; }

    .conv-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      margin-bottom: 2px;
    }

    .conv-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .conv-item.active {
      background: rgba(204, 120, 92, 0.15);
    }

    .conv-item-title {
      font-size: 13px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .conv-item-date {
      font-size: 11px;
      color: rgba(0, 0, 0, 0.4);
      margin-top: 2px;
    }

    .conv-loading {
      text-align: center;
      padding: 20px;
      color: rgba(0, 0, 0, 0.4);
      font-size: 13px;
    }

    /* Conversation item with menu */
    .conv-item {
      position: relative;
    }

    .conv-item-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .conv-item-info {
      flex: 1;
      min-width: 0;
    }

    .conv-star {
      color: #CC785C;
      font-size: 10px;
      margin-right: 4px;
    }

    .conv-menu-btn {
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      transition: all 0.15s;
      color: rgba(0, 0, 0, 0.4);
      font-size: 14px;
      flex-shrink: 0;
    }

    .conv-item:hover .conv-menu-btn {
      opacity: 1;
    }

    .conv-menu-btn:hover {
      background: rgba(0, 0, 0, 0.08);
      color: rgba(0, 0, 0, 0.7);
    }

    /* Dropdown menu */
    .conv-dropdown {
      position: absolute;
      right: 8px;
      top: 100%;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      z-index: 200;
      min-width: 120px;
      overflow: hidden;
      display: none;
    }

    .conv-dropdown.open {
      display: block;
    }

    .conv-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.7);
      cursor: pointer;
      transition: background 0.1s;
    }

    .conv-dropdown-item:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .conv-dropdown-item.delete {
      color: #FF453A;
    }

    .conv-dropdown-item.delete:hover {
      background: rgba(255, 69, 58, 0.1);
    }

    .conv-dropdown-icon {
      font-size: 12px;
      width: 16px;
      text-align: center;
    }

    /* Rename input */
    .conv-rename-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(204, 120, 92, 0.5);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      font-family: inherit;
      color: rgba(0, 0, 0, 0.8);
      outline: none;
    }

    .conv-rename-input:focus {
      border-color: #CC785C;
    }

    /* Messages */
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .messages::-webkit-scrollbar { width: 6px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.1); border-radius: 3px; }

    .message { max-width: 78%; }
    .message:not(.fly-in):not(.fade-in) { animation: msgIn 0.2s ease forwards; }
    @keyframes msgIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

    .message.user { align-self: flex-end; }
    .message.assistant { align-self: flex-start; }

    .message-content {
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      font-size: 14px;
    }

    .message.user .message-content {
      background: linear-gradient(145deg, #CC785C 0%, #D4846A 100%);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .message.assistant .message-content {
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-bottom-left-radius: 6px;
      color: #000;
    }

    /* Message edit feature */
    .message.user {
      position: relative;
    }
    .message.user .edit-btn {
      position: absolute;
      bottom: 4px;
      left: -28px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.15s, transform 0.15s;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .message.user .edit-btn svg {
      width: 12px;
      height: 12px;
      color: #666;
    }
    .message.user:hover .edit-btn {
      opacity: 1;
    }
    .message.user .edit-btn:hover {
      transform: scale(1.1);
      background: #fff;
    }
    .message.user.editing .edit-btn {
      display: none;
    }
    .message.user.editing .message-content {
      background: transparent;
      padding: 0;
    }
    .message-edit-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 200px;
    }
    .message-edit-textarea {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(204, 120, 92, 0.5);
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 14px;
      font-family: inherit;
      color: #000;
      resize: none;
      min-height: 40px;
      max-height: 200px;
      line-height: 1.5;
    }
    .message-edit-textarea:focus {
      outline: none;
      border-color: #CC785C;
      box-shadow: 0 0 0 3px rgba(204, 120, 92, 0.15);
    }
    .message-edit-actions {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }
    .message-edit-actions button {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s;
    }
    .message-edit-actions button:hover {
      transform: scale(1.1);
    }
    .message-edit-cancel {
      background: rgba(0, 0, 0, 0.08);
    }
    .message-edit-cancel svg {
      width: 14px;
      height: 14px;
      color: #666;
    }
    .message-edit-submit {
      background: linear-gradient(145deg, #CC785C 0%, #D4846A 100%);
      box-shadow: 0 2px 6px rgba(204, 120, 92, 0.3);
    }
    .message-edit-submit svg {
      width: 14px;
      height: 14px;
      color: white;
    }

    .message-content p { margin: 0 0 6px 0; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content p:first-child { margin-top: 0; }
    .message-content h1, .message-content h2, .message-content h3 { margin: 10px 0 4px; font-weight: 600; }
    .message-content h1:first-child, .message-content h2:first-child, .message-content h3:first-child { margin-top: 0; }
    .message-content h1 { font-size: 1.2em; }
    .message-content h2 { font-size: 1.1em; }
    .message-content h3 { font-size: 1.05em; }
    .message-content strong { font-weight: 600; }
    .message-content code {
      font-family: 'SF Mono', Menlo, monospace;
      font-size: 0.9em;
      background: rgba(0, 0, 0, 0.08);
      padding: 2px 6px;
      border-radius: 4px;
      color: #9a5d3a;
    }
    .message.user .message-content code { background: rgba(255, 255, 255, 0.2); color: #fff; }
    .message-content pre {
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 10px;
      padding: 12px;
      overflow-x: auto;
      margin: 8px 0;
    }
    .message-content pre code { background: transparent; padding: 0; font-size: 12px; line-height: 1.5; color: #333; }
    .message-content ul, .message-content ol { margin: 6px 0; padding-left: 20px; }
    .message-content li { margin: 2px 0; }
    .message-content blockquote {
      border-left: 3px solid #CC785C;
      margin: 8px 0;
      padding: 6px 12px;
      background: rgba(204, 120, 92, 0.1);
      border-radius: 0 8px 8px 0;
    }
    .message-content a { color: #9a5d3a; text-decoration: none; }
    .message-content a:hover { text-decoration: underline; }
    .message-content hr {
      border: none;
      border-top: 1px solid rgba(0, 0, 0, 0.12);
      margin: 12px 0;
    }

    /* Citation styling */
    .citation-link {
      color: #CC785C;
      text-decoration: underline;
      text-decoration-style: dotted;
      text-underline-offset: 2px;
    }
    .citation-link:hover {
      text-decoration-style: solid;
    }
    .citation-num {
      font-size: 10px;
      color: #CC785C;
      font-weight: 600;
      vertical-align: super;
      margin-left: 1px;
      cursor: pointer;
    }
    .citation-num:hover {
      text-decoration: underline;
    }

    /* Input area */
    .input-area {
      padding: 16px 20px 20px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      background: rgba(255, 255, 255, 0.7);
      border: 1px solid rgba(0, 0, 0, 0.15);
      border-radius: 22px;
      padding: 6px 6px 6px 16px;
      transition: all 0.2s;
    }

    .input-wrapper:focus-within {
      border-color: rgba(204, 120, 92, 0.5);
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 0 0 3px rgba(204, 120, 92, 0.15);
    }

    .input-area textarea {
      flex: 1;
      background: transparent;
      border: none;
      padding: 8px 0;
      color: #000;
      font-size: 14px;
      resize: none;
      font-family: inherit;
      min-height: 20px;
      max-height: 120px;
      line-height: 1.4;
    }

    .input-area textarea::placeholder { color: rgba(0, 0, 0, 0.4); }
    .input-area textarea:focus { outline: none; }

    .send-btn {
      background: linear-gradient(145deg, #CC785C 0%, #D4846A 100%);
      color: white;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(204, 120, 92, 0.3);
    }

    .send-btn:hover:not(:disabled) { transform: scale(1.05); }
    .send-btn:active:not(:disabled) { transform: scale(0.95); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .stop-btn {
      display: none;
      background: rgba(120, 120, 128, 0.16);
      color: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.08);
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 10px;
      font-weight: 500;
      transition: all 0.15s;
      align-self: flex-end;
      flex-shrink: 0;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .stop-btn:hover { background: rgba(120, 120, 128, 0.24); color: rgba(0, 0, 0, 0.8); }
    .stop-btn:active { transform: scale(0.95); }
    .stop-btn.visible { display: flex; align-items: center; justify-content: center; }
    .send-btn.hidden { display: none; }

    .loading-dots { display: flex; gap: 4px; padding: 4px 0; }
    .loading-dots span {
      width: 6px;
      height: 6px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 50%;
      animation: pulse 1.2s ease-in-out infinite;
    }
    .loading-dots span:nth-child(1) { animation-delay: 0s; }
    .loading-dots span:nth-child(2) { animation-delay: 0.15s; }
    .loading-dots span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes pulse { 0%, 80%, 100% { opacity: 0.35; } 40% { opacity: 1; } }

    .streaming-cursor {
      display: inline-block;
      width: 2px;
      height: 14px;
      background: #CC785C;
      margin-left: 2px;
      vertical-align: middle;
      animation: blink 1s step-end infinite;
    }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0; } }

    /* Thinking block */
    .thinking-block {
      background: rgba(204, 120, 92, 0.08);
      border: 1px solid rgba(204, 120, 92, 0.2);
      border-radius: 10px;
      margin-bottom: 10px;
      overflow: hidden;
    }

    .thinking-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      color: rgba(0, 0, 0, 0.5);
      font-weight: 500;
      transition: background 0.15s;
    }

    .thinking-header:hover {
      background: rgba(204, 120, 92, 0.05);
    }

    .thinking-icon {
      font-size: 14px;
      transition: transform 0.2s;
    }

    .thinking-block.expanded .thinking-icon {
      transform: rotate(90deg);
    }

    .thinking-label {
      flex: 1;
    }

    .thinking-spinner {
      width: 12px;
      height: 12px;
      border: 2px solid rgba(204, 120, 92, 0.3);
      border-top-color: #CC785C;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .thinking-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .thinking-block.expanded .thinking-content {
      max-height: 300px;
      overflow-y: auto;
    }

    .thinking-text {
      padding: 0 12px 10px;
      font-size: 12px;
      line-height: 1.5;
      color: rgba(0, 0, 0, 0.5);
      white-space: pre-wrap;
      font-family: 'SF Mono', Menlo, monospace;
    }

    /* Steps Timeline - Card wrapper for thinking/tool blocks */
    .steps-timeline {
      margin-top: 10px;
      margin-bottom: 12px;
      background: rgba(0, 0, 0, 0.03);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 12px;
      padding: 8px 12px 8px 8px;
    }

    .step-item {
      display: flex;
      flex-direction: row;
      min-height: 34px;
    }

    /* Timeline column with line and dot */
    .step-timeline-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-left: 4px;
      width: 24px;
      flex-shrink: 0;
    }

    .step-dot-row {
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 34px;
      justify-content: center;
    }

    .step-line-top {
      width: 1px;
      flex: 1;
      background: rgba(0, 0, 0, 0.12);
      min-height: 8px;
    }

    .step-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.12);
      flex-shrink: 0;
      margin: 4px 0;
    }

    .step-item.thinking .step-dot {
      background: #CC785C;
    }

    .step-item.tool .step-dot {
      background: #5856D6;
    }

    .step-line-bottom {
      width: 1px;
      flex: 1;
      background: rgba(0, 0, 0, 0.12);
      min-height: 8px;
    }

    .step-item:first-child .step-line-top {
      background: transparent;
    }

    .step-item:last-child .step-line-bottom {
      background: transparent;
    }

    .step-line-extend {
      width: 1px;
      flex: 1;
      background: rgba(0, 0, 0, 0.12);
      display: none;
    }

    .step-item.expanded .step-line-extend {
      display: block;
    }

    .step-item:last-child .step-line-extend {
      background: transparent;
    }

    /* Content column */
    .step-content-col {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 10px 6px 4px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .step-header:hover {
      background: rgba(0, 0, 0, 0.04);
    }

    .step-label {
      font-size: 13px;
      font-weight: 400;
      color: rgba(0, 0, 0, 0.55);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
      line-height: 1.4;
    }

    .step-item.thinking .step-label {
      color: rgba(0, 0, 0, 0.55);
    }

    .step-item.tool .step-label {
      color: rgba(0, 0, 0, 0.55);
    }

    .step-meta {
      font-size: 11px;
      color: rgba(0, 0, 0, 0.35);
      flex-shrink: 0;
      padding-left: 8px;
    }

    .step-spinner {
      width: 12px;
      height: 12px;
      border: 1.5px solid rgba(0, 0, 0, 0.12);
      border-top-color: rgba(0, 0, 0, 0.5);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      flex-shrink: 0;
    }

    .step-chevron {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      color: rgba(0, 0, 0, 0.35);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }

    .step-chevron svg {
      width: 16px;
      height: 16px;
    }

    .step-item.expanded .step-chevron {
      transform: rotate(90deg);
    }

    .step-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.2s;
      opacity: 0;
    }

    .step-item.expanded .step-content {
      max-height: 300px;
      overflow-y: auto;
      opacity: 1;
    }

    .step-text {
      padding: 8px 10px 12px 4px;
      font-size: 12px;
      line-height: 1.6;
      color: rgba(0, 0, 0, 0.5);
      white-space: pre-wrap;
      font-family: 'SF Mono', Menlo, monospace;
    }

    /* Web search results */
    .search-results {
      margin-top: 8px;
    }

    .search-result-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 6px;
      margin-bottom: 4px;
      text-decoration: none;
      transition: background 0.15s;
    }

    .search-result-item:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .search-result-favicon {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.05);
    }

    .search-result-info {
      flex: 1;
      min-width: 0;
    }

    .search-result-title {
      font-size: 11px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .search-result-site {
      font-size: 10px;
      color: rgba(0, 0, 0, 0.4);
    }

    /* Link card for web_fetch */
    .link-card {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 8px;
      margin-top: 8px;
      text-decoration: none;
      transition: background 0.15s, border-color 0.15s;
    }

    .link-card:hover {
      background: rgba(255, 255, 255, 0.8);
      border-color: rgba(0, 0, 0, 0.12);
    }

    .link-card-icon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      flex-shrink: 0;
      background: rgba(0, 0, 0, 0.05);
    }

    .link-card-info {
      flex: 1;
      min-width: 0;
    }

    .link-card-title {
      font-size: 12px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .link-card-url {
      font-size: 10px;
      color: rgba(0, 0, 0, 0.4);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Chat link items for conversation_search/recent_chats */
    .chat-links {
      margin-top: 8px;
    }

    .chat-link-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 6px;
      margin-bottom: 4px;
      text-decoration: none;
      transition: background 0.15s;
    }

    .chat-link-item:hover {
      background: rgba(255, 255, 255, 0.8);
    }

    .chat-link-icon {
      font-size: 14px;
      color: rgba(0, 0, 0, 0.4);
    }

    .chat-link-title {
      font-size: 11px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.8);
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* File operation display */
    .file-op {
      margin-top: 8px;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-op-icon {
      font-size: 14px;
    }

    .file-op-text {
      font-size: 11px;
      color: rgba(0, 0, 0, 0.6);
      font-family: 'SF Mono', Menlo, monospace;
    }

    .file-op.success .file-op-icon { color: #34C759; }
    .file-op.error .file-op-icon { color: #FF453A; }

    /* File preview */
    .file-preview {
      margin-top: 8px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 6px;
      overflow: hidden;
    }

    .file-preview-header {
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.04);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      font-size: 10px;
      font-weight: 500;
      color: rgba(0, 0, 0, 0.5);
      font-family: 'SF Mono', Menlo, monospace;
    }

    .file-preview .tool-output {
      margin: 0;
      border-radius: 0;
      border: none;
    }

    /* Tool result for non-search */
    .tool-output {
      margin-top: 8px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 6px;
      font-size: 11px;
      font-family: 'SF Mono', Menlo, monospace;
      color: rgba(0, 0, 0, 0.6);
      white-space: pre-wrap;
      max-height: 100px;
      overflow-y: auto;
    }

    .tool-output.error {
      color: #FF453A;
      background: rgba(255, 69, 58, 0.05);
    }

    .empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgba(0, 0, 0, 0.5);
      gap: 12px;
      padding-bottom: 60px;
    }

    .empty-state-icon {
      width: 56px;
      height: 56px;
      background: rgba(0, 0, 0, 0.05);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: rgba(0, 0, 0, 0.5);
    }

    .empty-state p { font-size: 15px; font-weight: 500; color: rgba(0, 0, 0, 0.6); }
    .empty-state .hint { font-size: 12px; color: rgba(0, 0, 0, 0.35); }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
      .login-card {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.2);
      }
      .login-container .subtitle { color: rgba(255, 255, 255, 0.5); }

      /* Home page dark mode */
      .home-input {
        color: #fff;
        border-bottom-color: rgba(255, 255, 255, 0.2);
      }
      .home-input:focus {
        border-bottom-color: #E8C4A0;
      }
      .home-input::placeholder {
        color: rgba(255, 255, 255, 0.35);
      }
      .model-option {
        border-color: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.5);
      }
      .model-option:hover {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.8);
      }
      .home-signout {
        color: rgba(255, 255, 255, 0.4);
      }
      .home-signout:hover {
        background: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.7);
      }

      .header {
        background: transparent;
      }
      .icon-btn {
        color: rgba(255, 255, 255, 0.5);
      }
      .icon-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
      }
      .model-badge { color: rgba(255, 255, 255, 0.4); }
      .sign-out-btn {
        color: rgba(255, 255, 255, 0.4);
      }
      .sign-out-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
      }

      .sidebar {
        background: rgba(28, 28, 30, 0.97);
        border-right-color: rgba(255, 255, 255, 0.08);
      }
      .sidebar-header { border-bottom-color: rgba(255, 255, 255, 0.06); }
      .sidebar-title { color: rgba(255, 255, 255, 0.6); }
      .sidebar-tab-indicator {
        background: rgba(255, 255, 255, 0.08);
      }
      .sidebar-tab:hover .sidebar-tab-indicator {
        background: rgba(255, 255, 255, 0.15);
      }
      .sidebar-tab-indicator::after {
        background: rgba(255, 255, 255, 0.35);
      }
      .conv-item:hover { background: rgba(255, 255, 255, 0.08); }
      .conv-item.active { background: rgba(204, 120, 92, 0.25); }
      .conv-item-title { color: rgba(255, 255, 255, 0.85); }
      .conv-item-date { color: rgba(255, 255, 255, 0.4); }
      .conv-loading { color: rgba(255, 255, 255, 0.4); }
      .conv-menu-btn {
        color: rgba(255, 255, 255, 0.4);
      }
      .conv-menu-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.8);
      }
      .conv-dropdown {
        background: rgba(40, 40, 42, 0.95);
        border-color: rgba(255, 255, 255, 0.15);
      }
      .conv-dropdown-item {
        color: rgba(255, 255, 255, 0.8);
      }
      .conv-dropdown-item:hover {
        background: rgba(255, 255, 255, 0.08);
      }
      .conv-dropdown-item.delete {
        color: #FF6B6B;
      }
      .conv-dropdown-item.delete:hover {
        background: rgba(255, 107, 107, 0.15);
      }
      .conv-rename-input {
        background: rgba(0, 0, 0, 0.3);
        border-color: rgba(204, 120, 92, 0.5);
        color: rgba(255, 255, 255, 0.9);
      }

      .messages::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); }

      .message.assistant .message-content {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.12);
        color: #fff;
      }
      .message-content code { background: rgba(0, 0, 0, 0.3); color: #E8C4A0; }
      .message-content pre { background: rgba(0, 0, 0, 0.4); border-color: rgba(255, 255, 255, 0.1); }
      .message-content pre code { color: rgba(255, 255, 255, 0.9); }
      .message-content a { color: #E8C4A0; }
      .message-content hr { border-top-color: rgba(255, 255, 255, 0.15); }

      .input-area {
        background: rgba(255, 255, 255, 0.06);
        border-top-color: rgba(255, 255, 255, 0.1);
      }
      .input-wrapper {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.15);
      }
      .input-wrapper:focus-within { background: rgba(255, 255, 255, 0.12); }
      .input-area textarea { color: #fff; }
      .input-area textarea::placeholder { color: rgba(255, 255, 255, 0.4); }

      .empty-state { color: rgba(255, 255, 255, 0.5); }
      .empty-state p { color: rgba(255, 255, 255, 0.7); }
      .empty-state .hint { color: rgba(255, 255, 255, 0.35); }
      .empty-state-icon {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.6);
      }
      .loading-dots span { background: rgba(255, 255, 255, 0.4); }

      .thinking-block {
        background: rgba(204, 120, 92, 0.12);
        border-color: rgba(204, 120, 92, 0.25);
      }
      .thinking-header { color: rgba(255, 255, 255, 0.5); }
      .thinking-header:hover { background: rgba(204, 120, 92, 0.1); }
      .thinking-text { color: rgba(255, 255, 255, 0.5); }

      .steps-timeline {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.08);
      }
      .step-line-top, .step-line-bottom, .step-line-extend { background: rgba(255, 255, 255, 0.15); }
      .step-item:last-child .step-line-extend { background: transparent; }
      .step-dot { background: rgba(255, 255, 255, 0.2); }
      .step-header:hover { background: rgba(255, 255, 255, 0.06); }
      .step-label { color: #fff !important; }
      .step-item.thinking .step-label { color: #fff !important; }
      .step-item.tool .step-label { color: #fff !important; }
      .step-meta { color: rgba(255, 255, 255, 0.6); }
      .step-chevron { color: rgba(255, 255, 255, 0.6); }
      .step-text { color: #fff !important; }
      .step-spinner { border-color: rgba(255, 255, 255, 0.15); border-top-color: rgba(255, 255, 255, 0.5); }
      .search-result-item {
        background: rgba(255, 255, 255, 0.08);
      }
      .search-result-item:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      .search-result-favicon { background: rgba(255, 255, 255, 0.1); }
      .search-result-title { color: rgba(255, 255, 255, 0.85); }
      .search-result-site { color: rgba(255, 255, 255, 0.4); }
      .link-card {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.1);
      }
      .link-card:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.15);
      }
      .link-card-icon { background: rgba(255, 255, 255, 0.1); }
      .link-card-title { color: rgba(255, 255, 255, 0.85); }
      .link-card-url { color: rgba(255, 255, 255, 0.4); }
      .chat-link-item {
        background: rgba(255, 255, 255, 0.08);
      }
      .chat-link-item:hover {
        background: rgba(255, 255, 255, 0.12);
      }
      .chat-link-icon { color: rgba(255, 255, 255, 0.4); }
      .chat-link-title { color: rgba(255, 255, 255, 0.85); }
      .file-op {
        background: rgba(255, 255, 255, 0.05);
      }
      .file-op-text { color: rgba(255, 255, 255, 0.6); }
      .file-preview {
        border-color: rgba(255, 255, 255, 0.1);
      }
      .file-preview-header {
        background: rgba(255, 255, 255, 0.05);
        border-bottom-color: rgba(255, 255, 255, 0.08);
        color: rgba(255, 255, 255, 0.5);
      }
      .tool-output {
        background: rgba(0, 0, 0, 0.2);
        color: rgba(255, 255, 255, 0.6);
      }
      .tool-output.error { background: rgba(255, 69, 58, 0.15); }
      .citation-link { color: #E8C4A0; }
      .citation-num { color: #E8C4A0; }
    }
  </style>
</head>
<body>
  <div id="login" class="login-container">
    <div class="login-card">
      <div class="logo"><img src="logo.svg" alt="Logo"></div>
      <h1>Claude</h1>
      <p class="subtitle">Sign in to continue</p>
      <button class="login-btn" onclick="login()">Continue with Claude</button>
      <p id="login-error" class="error"></p>
    </div>
  </div>

  <!-- Sidebar tab trigger (edge hover) -->
  <div class="sidebar-tab" id="sidebar-tab" onclick="toggleSidebar()">
    <div class="sidebar-tab-indicator" id="sidebar-tab-indicator"></div>
  </div>

  <!-- Sidebar overlay (shared) -->
  <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

  <!-- Sidebar (shared between home and chat) -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span class="sidebar-title">Chats</span>
      <div class="sidebar-spacer"></div>
      <button class="new-chat-btn" onclick="newChat(); closeSidebar();" title="New chat">+</button>
    </div>
    <div class="sidebar-content" id="sidebar-content">
      <div class="conv-loading">Loading...</div>
    </div>
  </div>

  <!-- Home page with model selector -->
  <div id="home" class="home-container">
    <!-- Draggable area for window movement -->
    <div class="home-drag-region"></div>
    <div class="home-content">
      <div class="home-logo">✦</div>
      <div class="home-input-area">
        <div class="home-input-wrapper">
          <textarea id="home-input" class="home-input" placeholder="Message Claude..." rows="1" onkeydown="handleHomeKeydown(event)" oninput="autoResizeHome(this)"></textarea>
          <div class="home-input-footer">
            <div class="model-selector">
              <button class="model-option active" data-model="claude-opus-4-5-20251101" onclick="selectModel(this)">Opus</button>
              <button class="model-option" data-model="claude-sonnet-4-5-20250929" onclick="selectModel(this)">Sonnet</button>
              <button class="model-option" data-model="claude-haiku-4-5-20251001" onclick="selectModel(this)">Haiku</button>
            </div>
            <button class="home-send-btn" id="home-send-btn" onclick="sendFromHome()">↑</button>
          </div>
        </div>
      </div>
    </div>
    <div class="home-footer">
      <button class="home-signout" onclick="logout()">Sign Out</button>
    </div>
  </div>

  <div id="chat" class="chat-container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <!-- Icons removed - using sidebar tab instead -->
      </div>
      <div class="header-right">
        <span class="model-badge">Opus 4.5</span>
        <button class="sign-out-btn" onclick="logout()">Sign Out</button>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="messages">
      <div class="empty-state" id="empty-state">
        <div class="empty-state-icon">✦</div>
        <p>What can I help with?</p>
        <span class="hint">Claude is ready</span>
      </div>
    </div>

    <!-- Input -->
    <div class="input-area">
      <div class="input-wrapper">
        <textarea id="input" placeholder="Message Claude..." rows="1" onkeydown="handleKeydown(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()">↑</button>
        <button class="stop-btn" id="stop-btn" onclick="stopGenerating()">■</button>
      </div>
    </div>
  </div>

  <script>
    let conversationId = null, parentMessageUuid = null, isLoading = false, currentStreamingElement = null;
    let streamingMessageUuid = null; // Track current streaming message UUID for stop/continue
    let conversations = [];
    let selectedModel = 'claude-opus-4-5-20251101';
    const modelDisplayNames = {
      'claude-opus-4-5-20251101': 'Opus 4.5',
      'claude-sonnet-4-5-20250929': 'Sonnet 4.5',
      'claude-haiku-4-5-20251001': 'Haiku 4.5'
    };
    // Track multiple content blocks during streaming
    const streamingBlocks = {
      thinkingBlocks: new Map(), // blockIndex -> { text, summary, isActive }
      toolBlocks: new Map(),     // blockIndex -> { name, message, result, isRunning, isError }
      textBlocks: new Map(),     // blockIndex -> { text }
      textContent: ''
    };

    function resetStreamingBlocks() {
      streamingBlocks.thinkingBlocks.clear();
      streamingBlocks.toolBlocks.clear();
      streamingBlocks.textBlocks.clear();
      streamingBlocks.textContent = '';
    }

    function parseMarkdown(t, citations) {
      if (!t) return '';

      // First apply citations if present (before escaping)
      let text = t;
      if (citations && citations.length > 0) {
        // Sort citations by start_index descending to avoid index shifting
        const sortedCitations = [...citations].sort((a, b) => (b.start_index || 0) - (a.start_index || 0));
        for (const cit of sortedCitations) {
          if (cit.start_index !== undefined && cit.end_index !== undefined) {
            const before = text.slice(0, cit.start_index);
            const cited = text.slice(cit.start_index, cit.end_index);
            const after = text.slice(cit.end_index);
            const citNumber = citations.indexOf(cit) + 1;
            // Wrap cited text with link and superscript citation number
            text = before + `[CITE_START:${cit.url || ''}:${cit.title || ''}]${cited}[CITE_END:${citNumber}]` + after;
          }
        }
      }

      // Escape HTML
      text = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      // Process citation markers after escaping
      text = text.replace(/\[CITE_START:([^:]*):([^\]]*)\]/g, '<a class="citation-link" href="$1" target="_blank" title="$2">')
                 .replace(/\[CITE_END:(\d+)\]/g, '</a><sup class="citation-num">[$1]</sup>');

      // Code blocks first (preserve newlines inside)
      text = text.replace(/```(\w*)\n([\s\S]*?)```/g,(m,l,c)=>`<pre><code>${c.trim()}</code></pre>`);

      // Inline code
      text = text.replace(/`([^`]+)`/g,'<code>$1</code>');

      // Headers
      text = text.replace(/^### (.*$)/gm,'<h3>$1</h3>')
                 .replace(/^## (.*$)/gm,'<h2>$1</h2>')
                 .replace(/^# (.*$)/gm,'<h1>$1</h1>');

      // Bold and italic
      text = text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
                 .replace(/\*(.+?)\*/g,'<em>$1</em>');

      // Blockquotes
      text = text.replace(/^&gt; (.*$)/gm,'<blockquote>$1</blockquote>');

      // List items - wrap consecutive items in <ul>
      text = text.replace(/^[\*\-] (.*$)/gm,'<li>$1</li>');
      text = text.replace(/(<li>.*<\/li>\n?)+/g, (match) => `<ul>${match.replace(/\n/g,'')}</ul>`);

      // Links
      text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');

      // Horizontal rules
      text = text.replace(/^---$/gm,'<hr>');

      // Paragraphs: double newlines become paragraph breaks
      // Single newlines within text become spaces (more natural reading)
      text = text.replace(/\n\n+/g,'</p><p>');
      text = text.replace(/\n/g,' ');
      text = '<p>' + text + '</p>';

      // Clean up empty paragraphs and paragraphs around block elements
      text = text.replace(/<p>\s*<\/p>/g,'');
      text = text.replace(/<p>\s*(<(pre|ul|h[1-6]|blockquote|hr)[^>]*>)/g,'$1');
      text = text.replace(/(<\/(pre|ul|h[1-6]|blockquote|hr)>)\s*<\/p>/g,'$1');
      text = text.replace(/<\/p>\s*<p>/g,'</p><p>');

      return text;
    }

    function autoResize(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
    function autoResizeHome(el) { el.style.height='auto'; el.style.height=Math.min(el.scrollHeight,200)+'px'; }

    // Home page functions
    function selectModel(btn) {
      document.querySelectorAll('.model-option').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedModel = btn.getAttribute('data-model');
    }

    function handleHomeKeydown(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendFromHome();
      }
    }

    async function sendFromHome() {
      const input = document.getElementById('home-input');
      const msg = input.value.trim();
      if (!msg || isLoading) return;

      isLoading = true;
      document.getElementById('home-send-btn').disabled = true;

      try {
        // Create conversation with selected model (do this before animation)
        const r = await window.claude.createConversation(selectedModel);
        conversationId = r.conversationId;
        parentMessageUuid = r.parentMessageUuid || r.uuid || crypto.randomUUID();

        // Start the transition animation
        const homeContainer = document.getElementById('home');
        const chatContainer = document.getElementById('chat');

        homeContainer.classList.add('transitioning');

        // Wait for the home animation to mostly complete
        await new Promise(resolve => setTimeout(resolve, 350));

        // Prepare chat view (hidden during setup)
        document.getElementById('messages').innerHTML = '';
        chatContainer.classList.add('entering');

        // Switch views
        homeContainer.classList.remove('active');
        chatContainer.classList.add('active');

        // Update model badge
        document.querySelector('.model-badge').textContent = modelDisplayNames[selectedModel] || 'Opus 4.5';
        document.getElementById('sidebar-tab').classList.remove('hidden');

        // Add user message with fly-in animation (apply class at creation to avoid base animation)
        const userMsgEl = addMessage('user', msg, false, null, 'fly-in');

        // Wait a bit, then add assistant loading message (apply class at creation)
        await new Promise(resolve => setTimeout(resolve, 200));

        currentStreamingElement = addMessage('assistant', '<div class="loading-dots"><span></span><span></span><span></span></div>', true, null, 'fade-in');

        // Show stop button in chat view (user might want to stop the first message)
        document.getElementById('send-btn').classList.add('hidden');
        document.getElementById('stop-btn').classList.add('visible');

        // Clean up animation classes after they complete
        setTimeout(() => {
          homeContainer.classList.remove('transitioning');
          chatContainer.classList.remove('entering');
          // Keep fly-in/fade-in classes on the initial pair to avoid re-triggering base animation
        }, 600);

        // Now send the message (animation is done, response can start streaming)
        await window.claude.sendMessage(conversationId, msg, parentMessageUuid);

        // Generate title for the new conversation (fire and forget - don't block on this)
        window.claude.generateTitle(conversationId, msg).then(() => {
          loadConversationsList();
        }).catch(err => {
          console.warn('Failed to generate title:', err);
          loadConversationsList();
        });

        // Clear home input
        input.value = '';
        input.style.height = 'auto';
      } catch(e) {
        if (currentStreamingElement) {
          currentStreamingElement.querySelector('.message-content').innerHTML = '<span style="color:#FF453A">Error: '+e.message+'</span>';
        }
        currentStreamingElement = null;
        isLoading = false;
        document.getElementById('home-send-btn').disabled = false;
        // Reset chat button state in case we're in chat view
        document.getElementById('send-btn').classList.remove('hidden');
        document.getElementById('stop-btn').classList.remove('visible');
      }
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days === 0) return 'Today';
      if (days === 1) return 'Yesterday';
      if (days < 7) return `${days} days ago`;
      return date.toLocaleDateString();
    }

    async function init() {
      if (await window.claude.getAuthStatus()) {
        showHome();
        loadConversationsList();
      } else {
        showLogin();
      }
      window.claude.onMessageThinking(d => {
        if (currentStreamingElement && d.conversationId === conversationId) {
          hideEmptyState();
          streamingBlocks.thinkingBlocks.set(d.blockIndex, {
            text: d.thinkingText || '',
            isActive: d.isThinking
          });
          updateStreamingContent();
        }
      });
      window.claude.onMessageThinkingStream(d => {
        if (currentStreamingElement && d.conversationId === conversationId) {
          const block = streamingBlocks.thinkingBlocks.get(d.blockIndex) || { isActive: true };
          block.text = d.thinking;
          if (d.summary) block.summary = d.summary;
          streamingBlocks.thinkingBlocks.set(d.blockIndex, block);
          updateStreamingContent();
        }
      });
      window.claude.onMessageToolUse(d => {
        if (currentStreamingElement && d.conversationId === conversationId) {
          hideEmptyState();
          streamingBlocks.toolBlocks.set(d.blockIndex, {
            name: d.toolName,
            message: d.message,
            input: d.input,
            isRunning: d.isRunning
          });
          updateStreamingContent();
          scrollToBottom();
        }
      });
      window.claude.onMessageToolResult(d => {
        if (currentStreamingElement && d.conversationId === conversationId) {
          // Find the matching tool block and add result
          streamingBlocks.toolBlocks.forEach((block, idx) => {
            if (block.name === d.toolName && block.isRunning) {
              block.result = d.result;
              block.isError = d.isError;
              block.isRunning = false;
            }
          });
          updateStreamingContent();
          scrollToBottom();
        }
      });
      window.claude.onMessageStream(d => {
        if (currentStreamingElement && d.conversationId === conversationId) {
          hideEmptyState();
          streamingBlocks.textContent = d.fullText;
          // Track text block by index for proper ordering
          if (d.blockIndex !== undefined) {
            streamingBlocks.textBlocks.set(d.blockIndex, { text: d.fullText });
          }
          updateStreamingContent();
          scrollToBottom();
        }
      });
      window.claude.onMessageComplete(d => {
        if (currentStreamingElement && d.conversationId === conversationId) {
          // Build interleaved content respecting block order
          const finalHtml = buildInterleavedContent(d.steps);

          currentStreamingElement.querySelector('.message-content').innerHTML = finalHtml;
          parentMessageUuid = d.messageUuid;
          currentStreamingElement = null;
          resetStreamingBlocks();
          isLoading = false;
          document.getElementById('send-btn').classList.remove('hidden');
          document.getElementById('stop-btn').classList.remove('visible');
          document.getElementById('input').focus();
        }
      });
    }

    function showLogin() {
      document.getElementById('login').style.display='flex';
      document.getElementById('home').classList.remove('active');
      document.getElementById('chat').classList.remove('active');
      // Hide sidebar tab on login screen
      document.getElementById('sidebar-tab').classList.add('hidden');
      closeSidebar();
    }
    function showHome() {
      document.getElementById('login').style.display='none';
      document.getElementById('home').classList.add('active');
      document.getElementById('chat').classList.remove('active');
      // Show sidebar tab on home page
      document.getElementById('sidebar-tab').classList.remove('hidden');
      // Focus the home input with blinking cursor
      setTimeout(() => document.getElementById('home-input').focus(), 100);
    }
    function showChat() {
      document.getElementById('login').style.display='none';
      document.getElementById('home').classList.remove('active');
      document.getElementById('chat').classList.add('active');
      // Show sidebar tab on chat page
      document.getElementById('sidebar-tab').classList.remove('hidden');
      // Update model badge
      document.querySelector('.model-badge').textContent = modelDisplayNames[selectedModel] || 'Opus 4.5';
    }
    function hideEmptyState() { const e=document.getElementById('empty-state'); if(e) e.style.display='none'; }

    // Sidebar functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebar-overlay');
      const sidebarTab = document.getElementById('sidebar-tab');
      const isOpening = !sidebar.classList.contains('open');
      sidebar.classList.toggle('open');
      overlay.classList.toggle('open');
      // Hide tab when sidebar is open
      if (isOpening) {
        sidebarTab.classList.add('hidden');
        loadConversationsList();
      } else {
        sidebarTab.classList.remove('hidden');
      }
    }

    function closeSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebar-overlay').classList.remove('open');
      document.getElementById('sidebar-tab').classList.remove('hidden');
    }

    // Cmd+S to toggle sidebar
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 's') {
        e.preventDefault();
        toggleSidebar();
      }
    });

    // Sidebar tab indicator follows mouse
    const sidebarTab = document.getElementById('sidebar-tab');
    const sidebarTabIndicator = document.getElementById('sidebar-tab-indicator');
    sidebarTab.addEventListener('mousemove', function(e) {
      const rect = sidebarTab.getBoundingClientRect();
      const relativeY = e.clientY - rect.top;
      sidebarTabIndicator.style.top = relativeY + 'px';
    });

    async function loadConversationsList() {
      const content = document.getElementById('sidebar-content');
      try {
        conversations = await window.claude.getConversations();
        renderConversationsList();
      } catch (e) {
        content.innerHTML = '<div class="conv-loading">Failed to load</div>';
      }
    }

    function renderConversationsList() {
      const content = document.getElementById('sidebar-content');
      if (!conversations || conversations.length === 0) {
        content.innerHTML = '<div class="conv-loading">No conversations yet</div>';
        return;
      }
      const escapeHtml = (text) => (text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
      content.innerHTML = conversations.map(c => `
        <div class="conv-item ${c.uuid === conversationId ? 'active' : ''}" data-uuid="${c.uuid}" data-starred="${c.is_starred || false}">
          <div class="conv-item-row">
            <div class="conv-item-info" onclick="loadConversation('${c.uuid}')">
              <div class="conv-item-title">${c.is_starred ? '<span class="conv-star">★</span>' : ''}${escapeHtml(c.name || c.summary || 'New conversation')}</div>
              <div class="conv-item-date">${formatDate(c.updated_at)}</div>
            </div>
            <button class="conv-menu-btn" onclick="event.stopPropagation(); toggleConvMenu('${c.uuid}')">⋯</button>
          </div>
          <div class="conv-dropdown" id="conv-dropdown-${c.uuid}">
            <div class="conv-dropdown-item" onclick="event.stopPropagation(); starConversation('${c.uuid}', ${!c.is_starred})">
              <span class="conv-dropdown-icon">${c.is_starred ? '☆' : '★'}</span>
              <span>${c.is_starred ? 'Unstar' : 'Star'}</span>
            </div>
            <div class="conv-dropdown-item" onclick="event.stopPropagation(); startRenameConversation('${c.uuid}')">
              <span class="conv-dropdown-icon">✎</span>
              <span>Rename</span>
            </div>
            <div class="conv-dropdown-item delete" onclick="event.stopPropagation(); deleteConversation('${c.uuid}')">
              <span class="conv-dropdown-icon">✕</span>
              <span>Delete</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    let openDropdownId = null;

    function toggleConvMenu(uuid) {
      const dropdown = document.getElementById(`conv-dropdown-${uuid}`);
      if (!dropdown) return;

      // Close any other open dropdown
      if (openDropdownId && openDropdownId !== uuid) {
        const oldDropdown = document.getElementById(`conv-dropdown-${openDropdownId}`);
        if (oldDropdown) oldDropdown.classList.remove('open');
      }

      dropdown.classList.toggle('open');
      openDropdownId = dropdown.classList.contains('open') ? uuid : null;
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (openDropdownId && !e.target.closest('.conv-item')) {
        const dropdown = document.getElementById(`conv-dropdown-${openDropdownId}`);
        if (dropdown) dropdown.classList.remove('open');
        openDropdownId = null;
      }
    });

    async function deleteConversation(uuid) {
      // Optimistic update - remove from UI immediately
      const deletedConv = conversations.find(c => c.uuid === uuid);
      conversations = conversations.filter(c => c.uuid !== uuid);

      // If we deleted the current conversation, go to home
      if (uuid === conversationId) {
        conversationId = null;
        parentMessageUuid = null;
        closeSidebar();
        showHome();
      } else {
        renderConversationsList();
      }

      // Fire and forget - API call in background
      try {
        await window.claude.deleteConversation(uuid);
      } catch (e) {
        console.error('Failed to delete conversation:', e);
        // Revert on failure
        if (deletedConv) {
          conversations.push(deletedConv);
          conversations.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
          renderConversationsList();
        }
      }
    }

    async function starConversation(uuid, isStarred) {
      // Optimistic update - update UI immediately
      const conv = conversations.find(c => c.uuid === uuid);
      const previousState = conv?.is_starred;
      if (conv) conv.is_starred = isStarred;
      renderConversationsList();

      // Fire and forget - API call in background
      try {
        await window.claude.starConversation(uuid, isStarred);
      } catch (e) {
        console.error('Failed to star conversation:', e);
        // Revert on failure
        if (conv) conv.is_starred = previousState;
        renderConversationsList();
      }
    }

    function startRenameConversation(uuid) {
      const convItem = document.querySelector(`.conv-item[data-uuid="${uuid}"]`);
      if (!convItem) return;

      // Close dropdown
      const dropdown = document.getElementById(`conv-dropdown-${uuid}`);
      if (dropdown) dropdown.classList.remove('open');
      openDropdownId = null;

      const conv = conversations.find(c => c.uuid === uuid);
      const currentName = conv?.name || conv?.summary || '';

      // Replace title with input
      const titleEl = convItem.querySelector('.conv-item-title');
      const originalHtml = titleEl.innerHTML;
      titleEl.innerHTML = `<input type="text" class="conv-rename-input" value="${currentName.replace(/"/g, '&quot;')}" onkeydown="handleRenameKeydown(event, '${uuid}')" onblur="finishRename('${uuid}', this.value)">`;
      const input = titleEl.querySelector('input');
      input.focus();
      input.select();
    }

    function handleRenameKeydown(e, uuid) {
      if (e.key === 'Enter') {
        e.preventDefault();
        finishRename(uuid, e.target.value);
      } else if (e.key === 'Escape') {
        e.preventDefault();
        renderConversationsList(); // Cancel and re-render
      }
    }

    async function finishRename(uuid, newName) {
      const trimmedName = newName.trim();
      if (!trimmedName) {
        renderConversationsList();
        return;
      }

      // Optimistic update - update UI immediately
      const conv = conversations.find(c => c.uuid === uuid);
      const previousName = conv?.name;
      if (conv) conv.name = trimmedName;
      renderConversationsList();

      // Fire and forget - API call in background
      try {
        await window.claude.renameConversation(uuid, trimmedName);
      } catch (e) {
        console.error('Failed to rename conversation:', e);
        // Revert on failure
        if (conv) conv.name = previousName;
        renderConversationsList();
      }
    }

    // Parse stored message content blocks into our steps format
    function parseStoredMessageContent(content) {
      const steps = [];
      let currentToolUse = null;

      for (const block of content) {
        if (block.type === 'thinking') {
          // Get the last summary if available
          const lastSummary = block.summaries && block.summaries.length > 0
            ? block.summaries[block.summaries.length - 1].summary
            : null;
          steps.push({
            type: 'thinking',
            thinkingText: block.thinking,
            thinkingSummary: lastSummary
          });
        } else if (block.type === 'tool_use') {
          currentToolUse = {
            type: 'tool',
            toolName: block.name,
            toolMessage: block.message || block.display_content?.text,
            toolInput: block.input
          };
        } else if (block.type === 'tool_result') {
          if (currentToolUse && currentToolUse.toolName === block.name) {
            // Parse tool result content
            let resultData = null;
            if (block.display_content) {
              resultData = block.display_content;
            } else if (block.content && Array.isArray(block.content)) {
              // Handle web_search results (array of knowledge items)
              if (block.name === 'web_search') {
                resultData = block.content.filter(c => c.type === 'knowledge').map(c => ({
                  title: c.title,
                  url: c.url,
                  metadata: c.metadata
                }));
              } else {
                // Extract text content
                const textContent = block.content.find(c => c.type === 'text');
                if (textContent) {
                  resultData = { type: 'text', text: textContent.text };
                }
              }
            }
            currentToolUse.toolResult = resultData;
            currentToolUse.isError = block.is_error;
            steps.push(currentToolUse);
            currentToolUse = null;
          }
        } else if (block.type === 'text') {
          steps.push({
            type: 'text',
            text: block.text,
            citations: block.citations
          });
        }
      }

      // If there's an unfinished tool_use (no result yet), still add it
      if (currentToolUse) {
        steps.push(currentToolUse);
      }

      return steps;
    }

    async function loadConversation(convId) {
      try {
        const conv = await window.claude.loadConversation(convId);
        conversationId = convId;

        // Reset button state when loading a conversation
        isLoading = false;
        document.getElementById('send-btn').classList.remove('hidden');
        document.getElementById('stop-btn').classList.remove('visible');

        // Switch to chat view first (in case we're on home page)
        showChat();

        // Clear messages
        const messagesEl = document.getElementById('messages');
        messagesEl.innerHTML = '';

        // Parse and display messages from chat_messages
        if (conv.chat_messages && conv.chat_messages.length > 0) {
          // Track the parent UUID for each message (the UUID of the message before it)
          let prevMsgUuid = convId;

          for (const msg of conv.chat_messages) {
            const role = msg.sender === 'human' ? 'user' : 'assistant';

            if (role === 'user') {
              // For user messages, just extract text
              let text = '';
              if (msg.content && Array.isArray(msg.content)) {
                for (const block of msg.content) {
                  if (block.type === 'text') {
                    text += block.text;
                  }
                }
              } else if (msg.text) {
                text = msg.text;
              }
              if (text) {
                // Pass the parent UUID (the message before this one) so we can branch from there
                addMessage('user', text, false, prevMsgUuid);
              }
            } else {
              // For assistant messages, parse all content blocks
              if (msg.content && Array.isArray(msg.content)) {
                const steps = parseStoredMessageContent(msg.content);
                if (steps.length > 0) {
                  const html = buildInterleavedContent(steps);
                  addMessageRaw('assistant', html);
                }
              } else if (msg.text) {
                addMessage('assistant', msg.text);
              }
            }

            // Track last message uuid for continuing conversation
            if (msg.uuid) {
              prevMsgUuid = msg.uuid;
              parentMessageUuid = msg.uuid;
            }
          }
        } else {
          // Show empty state if no messages
          messagesEl.innerHTML = '<div class="empty-state" id="empty-state"><div class="empty-state-icon">✦</div><p>What can I help with?</p><span class="hint">Claude is ready</span></div>';
          parentMessageUuid = convId;
        }

        closeSidebar();
        renderConversationsList();
        scrollToBottom();
      } catch (e) {
        console.error('Failed to load conversation:', e);
      }
    }

    async function login() {
      document.getElementById('login-error').textContent = '';
      const r = await window.claude.login();
      if (r.success) { showChat(); await startNewConversation(); loadConversationsList(); }
      else { document.getElementById('login-error').textContent = r.error||'Failed'; }
    }

    async function logout() {
      await window.claude.logout();
      conversationId = parentMessageUuid = null;
      conversations = [];
      document.getElementById('messages').innerHTML = '<div class="empty-state" id="empty-state"><div class="empty-state-icon">✦</div><p>What can I help with?</p><span class="hint">Claude is ready</span></div>';
      showLogin();
    }

    async function startNewConversation() {
      try {
        const r = await window.claude.createConversation();
        conversationId = r.conversationId;
        parentMessageUuid = r.parentMessageUuid || r.uuid || crypto.randomUUID();
      } catch(e) { addMessage('assistant','Failed: '+e.message); }
    }

    function newChat() {
      // Go back to home page instead of creating a conversation immediately
      conversationId = null;
      parentMessageUuid = null;
      document.getElementById('home-input').value = '';
      closeSidebar();
      showHome();
    }

    function handleKeydown(e) { if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

    async function sendMessage() {
      const input = document.getElementById('input'), msg = input.value.trim();
      if (!msg || isLoading || !conversationId) return;
      isLoading = true; input.value = ''; input.style.height = 'auto';
      document.getElementById('send-btn').classList.add('hidden');
      document.getElementById('stop-btn').classList.add('visible');
      hideEmptyState();
      addMessage('user', msg);
      currentStreamingElement = addMessage('assistant', '<div class="loading-dots"><span></span><span></span><span></span></div>', true);
      try { await window.claude.sendMessage(conversationId, msg, parentMessageUuid); }
      catch(e) {
        if (currentStreamingElement) currentStreamingElement.querySelector('.message-content').innerHTML = '<span style="color:#FF453A">Error: '+e.message+'</span>';
        currentStreamingElement = null; isLoading = false;
        document.getElementById('send-btn').classList.remove('hidden');
        document.getElementById('stop-btn').classList.remove('visible');
      }
    }

    async function stopGenerating() {
      if (!conversationId || !isLoading) return;
      try {
        await window.claude.stopResponse(conversationId);
        // After stopping, we need to get the conversation to find the partial message UUID
        const conv = await window.claude.loadConversation(conversationId);
        // Find the last assistant message UUID for continuing
        if (conv.chat_messages && conv.chat_messages.length > 0) {
          const lastMsg = conv.chat_messages[conv.chat_messages.length - 1];
          if (lastMsg.uuid) {
            parentMessageUuid = lastMsg.uuid;
          }
        }
      } catch(e) {
        console.error('Stop failed:', e);
      }
      // Handle the streaming element - either show partial content or remove loading bubble
      if (currentStreamingElement) {
        const content = currentStreamingElement.querySelector('.message-content');
        const hasLoadingDots = content && content.querySelector('.loading-dots');
        const hasContent = streamingBlocks.textContent.trim().length > 0;

        if (hasLoadingDots && !hasContent) {
          // Just loading dots with no content - remove the element
          currentStreamingElement.remove();
        } else if (hasContent) {
          // Has partial content - show it with stopped indicator
          const finalHtml = buildInterleavedContent([]);
          content.innerHTML = finalHtml || '<span style="opacity:0.5;font-style:italic">Stopped</span>';
        }
      }
      // Reset UI state
      isLoading = false;
      document.getElementById('send-btn').classList.remove('hidden');
      document.getElementById('stop-btn').classList.remove('visible');
      currentStreamingElement = null;
      resetStreamingBlocks();
      document.getElementById('input').focus();
    }

    // SVG icons for edit feature
    const pencilSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>`;
    const checkSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
    const closeSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;

    function addMessage(role, content, raw=false, storedParentUuid=null, extraClasses='') {
      const el = document.createElement('div'); el.className = 'message '+role+(extraClasses ? ' '+extraClasses : '');
      const c = document.createElement('div'); c.className = 'message-content';
      c.innerHTML = role==='user' ? content.replace(/</g,'&lt;').replace(/>/g,'&gt;') : (raw ? content : parseMarkdown(content));
      el.appendChild(c);

      // Add edit button for user messages
      if (role === 'user') {
        // Store the parent UUID that was active when this message was sent
        el.dataset.parentUuid = storedParentUuid || parentMessageUuid || conversationId;
        el.dataset.originalText = content;

        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.innerHTML = pencilSvg;
        editBtn.onclick = (e) => { e.stopPropagation(); startEditMessage(el); };
        el.appendChild(editBtn);
      }

      document.getElementById('messages').appendChild(el);
      scrollToBottom();
      return el;
    }

    function addMessageRaw(role, htmlContent, storedParentUuid=null) {
      const el = document.createElement('div'); el.className = 'message '+role;
      const c = document.createElement('div'); c.className = 'message-content';
      c.innerHTML = htmlContent;
      el.appendChild(c);
      document.getElementById('messages').appendChild(el);
      scrollToBottom();
      return el;
    }

    function scrollToBottom() { const m=document.getElementById('messages'); m.scrollTop=m.scrollHeight; }

    // Message editing functions
    function startEditMessage(msgEl) {
      if (isLoading) return;
      msgEl.classList.add('editing');
      const contentEl = msgEl.querySelector('.message-content');
      const originalText = msgEl.dataset.originalText || contentEl.textContent;

      contentEl.innerHTML = `
        <div class="message-edit-container">
          <textarea class="message-edit-textarea">${originalText.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</textarea>
          <div class="message-edit-actions">
            <button class="message-edit-cancel" onclick="cancelEditMessage(this)">${closeSvg}</button>
            <button class="message-edit-submit" onclick="submitEditMessage(this)">${checkSvg}</button>
          </div>
        </div>
      `;

      const textarea = contentEl.querySelector('.message-edit-textarea');
      textarea.focus();
      textarea.setSelectionRange(textarea.value.length, textarea.value.length);

      // Auto-resize textarea
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
      textarea.oninput = () => {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
      };

      // Handle Enter key
      textarea.onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          submitEditMessage(textarea);
        } else if (e.key === 'Escape') {
          cancelEditMessage(textarea);
        }
      };
    }

    function cancelEditMessage(btnOrTextarea) {
      const msgEl = btnOrTextarea.closest('.message');
      msgEl.classList.remove('editing');
      const contentEl = msgEl.querySelector('.message-content');
      const originalText = msgEl.dataset.originalText;
      contentEl.innerHTML = originalText.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    async function submitEditMessage(btnOrTextarea) {
      if (isLoading) return;
      const msgEl = btnOrTextarea.closest('.message');
      const textarea = msgEl.querySelector('.message-edit-textarea');
      const newText = textarea.value.trim();

      if (!newText) {
        cancelEditMessage(btnOrTextarea);
        return;
      }

      // Get the parent UUID for this message (the point we want to branch from)
      const branchParentUuid = msgEl.dataset.parentUuid;

      // Remove all messages after this one
      const messagesContainer = document.getElementById('messages');
      let nextEl = msgEl.nextElementSibling;
      while (nextEl) {
        const toRemove = nextEl;
        nextEl = nextEl.nextElementSibling;
        toRemove.remove();
      }

      // Update the message element
      msgEl.classList.remove('editing');
      msgEl.dataset.originalText = newText;
      const contentEl = msgEl.querySelector('.message-content');
      contentEl.innerHTML = newText.replace(/</g,'&lt;').replace(/>/g,'&gt;');

      // Set parentMessageUuid to branch from this point
      parentMessageUuid = branchParentUuid;

      // Send the edited message
      isLoading = true;
      document.getElementById('send-btn').disabled = true;
      currentStreamingElement = addMessage('assistant', '<div class="loading-dots"><span></span><span></span><span></span></div>', true);

      try {
        await window.claude.sendMessage(conversationId, newText, parentMessageUuid);
      } catch(e) {
        if (currentStreamingElement) currentStreamingElement.querySelector('.message-content').innerHTML = '<span style="color:#FF453A">Error: '+e.message+'</span>';
        currentStreamingElement = null;
        isLoading = false;
        document.getElementById('send-btn').disabled = false;
      }
    }

    // SVG chevron icon matching Claude's design
    const chevronSvg = `<svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor"><path d="M14.128 7.16482C14.3126 6.95983 14.6298 6.94336 14.835 7.12771C15.0402 7.31242 15.0567 7.62952 14.8721 7.83477L10.372 12.835L10.2939 12.9053C10.2093 12.9667 10.1063 13 9.99995 13C9.85833 12.9999 9.72264 12.9402 9.62788 12.835L5.12778 7.83477L5.0682 7.75273C4.95072 7.55225 4.98544 7.28926 5.16489 7.12771C5.34445 6.96617 5.60969 6.95939 5.79674 7.09744L5.87193 7.16482L9.99995 11.7519L14.128 7.16482Z"/></svg>`;

    // Build a step item for the timeline
    function buildStepItem(step, isActive) {
      const escapeHtml = (text) => (text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      if (step.type === 'thinking') {
        const summary = step.thinkingSummary || step.summary;
        const label = summary ? escapeHtml(summary) : 'Thinking';
        const idx = step.index !== undefined ? step.index : '';
        return `
          <div class="step-item thinking" data-index="${idx}" onclick="this.classList.toggle('expanded')">
            <div class="step-timeline-col">
              <div class="step-dot-row">
                <div class="step-line-top"></div>
                <div class="step-dot"></div>
                <div class="step-line-bottom"></div>
              </div>
              <div class="step-line-extend"></div>
            </div>
            <div class="step-content-col">
              <div class="step-header">
                <span class="step-label">${label}</span>
                ${isActive ? '<div class="step-spinner"></div>' : `<span class="step-chevron">${chevronSvg}</span>`}
              </div>
              <div class="step-content">
                <div class="step-text">${escapeHtml(step.thinkingText || step.text)}</div>
              </div>
            </div>
          </div>
        `;
      } else if (step.type === 'tool') {
        const toolLabels = {
          'web_search': 'Searching the web',
          'web_fetch': 'Fetching page',
          'bash_tool': 'Running command',
          'create_file': 'Creating file',
          'str_replace': 'Editing file',
          'view': 'Reading file',
          'conversation_search': 'Searching past chats',
          'recent_chats': 'Getting recent chats'
        };
        const message = step.toolMessage || step.message;
        const label = message || toolLabels[step.toolName] || `Using ${step.toolName}`;
        const resultHtml = buildToolResultContent(step.toolName, step.toolResult, step.isError);
        const idx = step.index !== undefined ? step.index : '';

        return `
          <div class="step-item tool ${step.toolResult ? '' : 'active'}" data-index="${idx}" onclick="this.classList.toggle('expanded')">
            <div class="step-timeline-col">
              <div class="step-dot-row">
                <div class="step-line-top"></div>
                <div class="step-dot"></div>
                <div class="step-line-bottom"></div>
              </div>
              <div class="step-line-extend"></div>
            </div>
            <div class="step-content-col">
              <div class="step-header">
                <span class="step-label">${escapeHtml(label)}</span>
                ${isActive && !step.toolResult ? '<div class="step-spinner"></div>' : `<span class="step-chevron">${chevronSvg}</span>`}
              </div>
              <div class="step-content">${resultHtml}</div>
            </div>
          </div>
        `;
      }
      return '';
    }

    // Fallback favicon as a data URI
    const FALLBACK_FAVICON = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiAxNiI+PGNpcmNsZSBjeD0iOCIgY3k9IjgiIHI9IjciIGZpbGw9IiNkZGQiLz48L3N2Zz4=';

    // Build result content based on tool type and display_content format
    function buildToolResultContent(toolName, result, isError) {
      if (!result) return '';
      const escapeHtml = (text) => (text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      // Handle typed display_content formats
      if (result.type === 'rich_link' && result.link) {
        // web_fetch: rich_link with title, url, icon_url
        const link = result.link;
        const title = link.title || link.url || 'Fetched page';
        const url = link.url || '';
        let icon = link.icon_url || '';
        if (!icon && url) {
          try {
            const domain = new URL(url).hostname;
            icon = `https://www.google.com/s2/favicons?sz=32&domain=${encodeURIComponent(domain)}`;
          } catch {}
        }
        if (!icon) icon = FALLBACK_FAVICON;
        return `
          <a class="link-card" href="${escapeHtml(url)}" target="_blank">
            <img class="link-card-icon" src="${escapeHtml(icon)}" onerror="this.onerror=null;this.src='${FALLBACK_FAVICON}'">
            <div class="link-card-info">
              <div class="link-card-title">${escapeHtml(title)}</div>
              <div class="link-card-url">${escapeHtml(url)}</div>
            </div>
          </a>
        `;
      }

      if (result.type === 'rich_content' && result.content) {
        // conversation_search/recent_chats: array of link objects
        let html = '<div class="chat-links">';
        for (const item of result.content.slice(0, 5)) {
          const title = item.title || 'Chat';
          const url = item.url || '';
          html += `
            <a class="chat-link-item" href="${escapeHtml(url)}" target="_blank">
              <span class="chat-link-icon">💬</span>
              <span class="chat-link-title">${escapeHtml(title)}</span>
            </a>
          `;
        }
        html += '</div>';
        return html;
      }

      if (result.type === 'json_block') {
        // bash_tool, view, create_file: json_block with code/stdout/stderr/filename
        const code = result.code || '';
        const filename = result.filename || '';
        const stdout = result.stdout || '';
        const stderr = result.stderr || '';
        const returncode = result.returncode;

        // Bash output
        if (stdout || stderr || returncode !== undefined) {
          const output = stdout || stderr || '';
          const hasError = isError || returncode !== 0;
          if (output) {
            return `<div class="tool-output ${hasError ? 'error' : ''}">${escapeHtml(output.substring(0, 500))}${output.length > 500 ? '...' : ''}</div>`;
          }
          return hasError ? '<div class="file-op error"><span class="file-op-icon">✗</span><span class="file-op-text">Command failed</span></div>' : '';
        }

        // File content (view/create_file)
        if (code && filename) {
          const shortFilename = filename.split('/').pop();
          const preview = code.substring(0, 200);
          return `
            <div class="file-preview">
              <div class="file-preview-header">${escapeHtml(shortFilename)}</div>
              <div class="tool-output">${escapeHtml(preview)}${code.length > 200 ? '...' : ''}</div>
            </div>
          `;
        }

        // Generic code block
        if (code) {
          return `<div class="tool-output">${escapeHtml(code.substring(0, 300))}${code.length > 300 ? '...' : ''}</div>`;
        }
      }

      if (result.type === 'text') {
        // Simple text result (str_replace, create_file success)
        const text = result.text || '';
        if (text.toLowerCase().includes('success')) {
          return `<div class="file-op success"><span class="file-op-icon">✓</span><span class="file-op-text">${escapeHtml(text)}</span></div>`;
        }
        return `<div class="tool-output ${isError ? 'error' : ''}">${escapeHtml(text)}</div>`;
      }

      // Web search results - array of search results
      if (Array.isArray(result)) {
        let html = '<div class="search-results">';
        for (const item of result.slice(0, 5)) { // Show top 5
          const siteDomain = item.metadata?.site_domain || '';
          const siteName = item.metadata?.site_name || siteDomain || '';
          let favicon = item.metadata?.favicon_url || '';
          if (!favicon && siteDomain) {
            favicon = `https://www.google.com/s2/favicons?sz=32&domain=${encodeURIComponent(siteDomain)}`;
          }
          if (!favicon) favicon = FALLBACK_FAVICON;
          html += `
            <a class="search-result-item" href="${escapeHtml(item.url)}" target="_blank">
              <img class="search-result-favicon" src="${escapeHtml(favicon)}" onerror="this.onerror=null;this.src='${FALLBACK_FAVICON}'">
              <div class="search-result-info">
                <div class="search-result-title">${escapeHtml(item.title)}</div>
                <div class="search-result-site">${escapeHtml(siteName)}</div>
              </div>
            </a>
          `;
        }
        html += '</div>';
        return html;
      }

      // Legacy fallback handling
      if (result.link) {
        const link = result.link;
        const title = link.title || link.url || 'Fetched page';
        const url = link.url || '';
        let icon = link.icon_url || '';
        if (!icon && url) {
          try {
            const domain = new URL(url).hostname;
            icon = `https://www.google.com/s2/favicons?sz=32&domain=${encodeURIComponent(domain)}`;
          } catch {}
        }
        if (!icon) icon = FALLBACK_FAVICON;
        return `
          <a class="link-card" href="${escapeHtml(url)}" target="_blank">
            <img class="link-card-icon" src="${escapeHtml(icon)}" onerror="this.onerror=null;this.src='${FALLBACK_FAVICON}'">
            <div class="link-card-info">
              <div class="link-card-title">${escapeHtml(title)}</div>
              <div class="link-card-url">${escapeHtml(url)}</div>
            </div>
          </a>
        `;
      }

      if (result.rich_content) {
        let html = '<div class="chat-links">';
        const items = Array.isArray(result.rich_content) ? result.rich_content : [result.rich_content];
        for (const item of items.slice(0, 5)) {
          const title = item.title || item.text || 'Chat';
          const url = item.url || item.href || '';
          html += `
            <a class="chat-link-item" href="${escapeHtml(url)}" target="_blank">
              <span class="chat-link-icon">💬</span>
              <span class="chat-link-title">${escapeHtml(title)}</span>
            </a>
          `;
        }
        html += '</div>';
        return html;
      }

      // Generic text result
      if (result.text) {
        return `<div class="tool-output ${isError ? 'error' : ''}">${escapeHtml(result.text)}</div>`;
      }

      // String result
      if (typeof result === 'string') {
        return `<div class="tool-output ${isError ? 'error' : ''}">${escapeHtml(result)}</div>`;
      }

      return '';
    }

    // Build the unified timeline from steps (returns array of {index, html} for interleaving)
    function buildStepsTimeline(steps) {
      if (!steps || steps.length === 0) return '';
      let html = '<div class="steps-timeline">';
      for (const step of steps) {
        html += buildStepItem(step, false);
      }
      html += '</div>';
      return html;
    }

    // Build interleaved content respecting block order
    function buildInterleavedContent(steps) {
      if (!steps || steps.length === 0) return '';

      let html = '';
      let currentTimelineSteps = [];

      // Process steps in order, grouping non-text steps into timelines
      for (const step of steps) {
        if (step.type === 'text') {
          // Flush any pending timeline steps
          if (currentTimelineSteps.length > 0) {
            html += '<div class="steps-timeline">';
            for (const ts of currentTimelineSteps) {
              html += buildStepItem(ts, false);
            }
            html += '</div>';
            currentTimelineSteps = [];
          }
          // Add the text content with citations
          html += parseMarkdown(step.text, step.citations);
        } else {
          // Accumulate thinking/tool steps
          currentTimelineSteps.push(step);
        }
      }

      // Flush any remaining timeline steps
      if (currentTimelineSteps.length > 0) {
        html += '<div class="steps-timeline">';
        for (const ts of currentTimelineSteps) {
          html += buildStepItem(ts, false);
        }
        html += '</div>';
      }

      return html;
    }

    // Build streaming content from current blocks with interleaving
    function buildStreamingContent() {
      // Combine all blocks ordered by index
      const allBlocks = [];

      streamingBlocks.thinkingBlocks.forEach((block, idx) => {
        allBlocks.push({
          type: 'thinking',
          index: idx,
          thinkingText: block.text,
          thinkingSummary: block.summary,
          isActive: block.isActive
        });
      });

      streamingBlocks.toolBlocks.forEach((block, idx) => {
        allBlocks.push({
          type: 'tool',
          index: idx,
          toolName: block.name,
          toolMessage: block.message,
          toolResult: block.result,
          isError: block.isError,
          isActive: block.isRunning
        });
      });

      streamingBlocks.textBlocks.forEach((block, idx) => {
        allBlocks.push({
          type: 'text',
          index: idx,
          text: block.text
        });
      });

      if (allBlocks.length === 0) return '';

      // Sort by index
      allBlocks.sort((a, b) => a.index - b.index);

      // Build interleaved content
      let html = '';
      let currentTimelineSteps = [];

      for (const step of allBlocks) {
        if (step.type === 'text') {
          // Flush pending timeline
          if (currentTimelineSteps.length > 0) {
            html += '<div class="steps-timeline">';
            for (const ts of currentTimelineSteps) {
              html += buildStepItem(ts, ts.isActive);
            }
            html += '</div>';
            currentTimelineSteps = [];
          }
          // Add text with cursor
          html += parseMarkdown(step.text) + '<span class="streaming-cursor"></span>';
        } else {
          currentTimelineSteps.push(step);
        }
      }

      // Flush remaining timeline
      if (currentTimelineSteps.length > 0) {
        html += '<div class="steps-timeline">';
        for (const ts of currentTimelineSteps) {
          html += buildStepItem(ts, ts.isActive);
        }
        html += '</div>';
      }

      return html;
    }

    function updateStreamingContent() {
      if (!currentStreamingElement) return;
      const contentEl = currentStreamingElement.querySelector('.message-content');

      // Preserve expanded states before updating
      const expandedIndices = new Set();
      contentEl.querySelectorAll('.step-item.expanded').forEach(el => {
        const idx = el.getAttribute('data-index');
        if (idx) expandedIndices.add(idx);
      });

      // Build interleaved streaming content
      let html = buildStreamingContent();

      // Show loading dots if nothing yet
      if (!html) {
        html = '<div class="loading-dots"><span></span><span></span><span></span></div>';
      }

      contentEl.innerHTML = html;

      // Restore expanded states
      expandedIndices.forEach(idx => {
        const el = contentEl.querySelector(`.step-item[data-index="${idx}"]`);
        if (el) el.classList.add('expanded');
      });
    }

    // Setup sidebar tab hover behavior
    function setupSidebarHover() {
      const sidebarTab = document.getElementById('sidebar-tab');
      let hoverTimeout;

      sidebarTab.addEventListener('mouseenter', () => {
        // Open sidebar after a short delay on hover
        hoverTimeout = setTimeout(() => {
          toggleSidebar();
        }, 200);
      });

      sidebarTab.addEventListener('mouseleave', () => {
        // Cancel if user leaves before delay
        clearTimeout(hoverTimeout);
      });
    }

    init();
    setupSidebarHover();
  </script>
</body>
</html>
